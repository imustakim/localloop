name: Deploy to Pantheon Dev

on:
  push:
    branches:
      - dev

jobs:
  deploy-to-pantheon-dev:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: gd, zip, intl
          tools: composer

      - name: Install Composer Dependencies
        run: composer install --no-progress --no-dev

      - name: Install Terminus
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          terminus-version: ^3

      - name: Authenticate with Pantheon
        run: terminus auth:login --machine-token=${{ secrets.PANTHEON_MACHINE_TOKEN }}

      - name: Add SSH Key for Pantheon
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PANTHEON_SSH_PRIVATE_KEY }}

      - name: Push to Pantheon Dev Environment
        env:
          PANTHEON_SITE_ID: ${{ secrets.PANTHEON_SITE }}
        run: |
          git remote add pantheon "ssh://codeserver.dev.$PANTHEON_SITE_ID@codeserver.dev.$PANTHEON_SITE_ID.drush.in:2222/~/repository.git"
          git push pantheon dev:master --force

      - name: Run post-deployment commands on Pantheon
        env:
          PANTHEON_SITE_ID: ${{ secrets.PANTHEON_SITE }}
        run: |
          terminus connection:set $PANTHEON_SITE_ID.dev sftp
          terminus drush $PANTHEON_SITE_ID.dev -- config:import -y
          terminus drush $PANTHEON_SITE_ID.dev -- updatedb -y
          terminus drush $PANTHEON_SITE_ID.dev -- cr






