name: Deploy to Pantheon Dev

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    name: Deploy to Pantheon Dev
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, gd, curl, json, zip
          tools: composer

      - name: Add SSH Key for Pantheon
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PANTHEON_SSH_PRIVATE_KEY }}

      - name: Install Terminus
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.PANTHEON_MACHINE_TOKEN }}
      - name: List sites
        run: terminus site:list
      - name: Set Connection to the Dev environment
        run: |
          terminus connection:set ${{ secrets.PANTHEON_SITE }}.dev git
      - name: Push code to Pantheon Dev environment
        run: |
          git add remote pantheon ssh://codeserver.dev.${{ secrets.PANTHEON_SITE }}.drush.in:2222/~/repository.git
          git fetch
          git push pantheon dev:master --force

      - name: Import config
        run: terminus drush ${{ secrets.PANTHEON_SITE }}.dev -- config-import -y

      - name: Run database updates
        run: terminus drush ${{ secrets.PANTHEON_SITE }}.dev -- updatedb -y

      - name: Clear cache
        run: terminus drush ${{ secrets.PANTHEON_SITE }}.dev -- cr